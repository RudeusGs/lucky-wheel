<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Wheel - V√≤ng Quay May M·∫Øn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* Premium background effects */
        body::before {
            content: '';
            position: fixed;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(102, 51, 153, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            top: -100px;
            left: -100px;
            z-index: 0;
            animation: float 20s infinite ease-in-out;
        }

        body::after {
            content: '';
            position: fixed;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(102, 204, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            bottom: -150px;
            right: -150px;
            z-index: 0;
            animation: float 25s infinite ease-in-out reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(20px); }
        }

        .container {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }

        /* Gradient title with animation */
        h1 {
            color: #fff;
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #66ccff 0%, #cc99ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95em;
            margin-bottom: 18px;
            letter-spacing: 0.5px;
        }

        .top-actions {
            margin-bottom: 24px;
        }

        /* N√∫t t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p */
        .login-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 20px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.85);
            color: #bfdbfe;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            letter-spacing: 0.3px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
            transition: all 0.25s ease;
        }

        .login-button:hover {
            background: rgba(30, 64, 175, 0.95);
            border-color: rgba(129, 140, 248, 0.9);
            color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(30, 64, 175, 0.6);
        }

        /* Wheel wrapper with premium shadow */
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto 40px;
            filter: drop-shadow(0 30px 60px rgba(102, 51, 153, 0.4))
                    drop-shadow(0 0 40px rgba(102, 204, 255, 0.2));
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transform: rotate(0deg);
            will-change: transform;
            backface-visibility: hidden;
            transition: transform 5.5s cubic-bezier(0.17, 0.67, 0.12, 0.98);
        }

        .wheel.spinning {
            filter: brightness(1.15) saturate(1.1);
            animation: wheelPulse 0.6s alternate infinite;
        }

        @keyframes wheelPulse {
            0% {
                box-shadow:
                    0 10px 50px rgba(102, 51, 153, 0.35),
                    inset 0 0 20px rgba(255, 255, 255, 0.15);
            }
            100% {
                box-shadow:
                    0 15px 60px rgba(102, 51, 153, 0.55),
                    inset 0 0 24px rgba(255, 255, 255, 0.22);
            }
        }

        .wheel svg {
            width: 100%;
            height: 100%;
            display: block;
            filter: drop-shadow(0 10px 30px rgba(102, 51, 153, 0.3));
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #66ccff;
            z-index: 20;
            filter: drop-shadow(0 5px 10px rgba(102, 204, 255, 0.6));
            animation: pointerGlow 2s infinite;
        }

        @keyframes pointerGlow {
            0%, 100% { filter: drop-shadow(0 5px 10px rgba(102, 204, 255, 0.6)); }
            50% { filter: drop-shadow(0 8px 15px rgba(102, 204, 255, 0.9)); }
        }

        .pointer.animate {
            animation: pointerBounce 0.5s ease-out;
        }

        @keyframes pointerBounce {
            0% { transform: translateX(-50%) translateY(-10px) scale(1.1); }
            50% { transform: translateX(-50%) translateY(0px) scale(1); }
            100% { transform: translateX(-50%) translateY(0px) scale(1); }
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #663399 0%, #9933cc 100%);
            border-radius: 50%;
            z-index: 21;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 10px 30px rgba(102, 51, 153, 0.5),
                        0 0 20px rgba(102, 204, 255, 0.3);
            border: 3px solid rgba(102, 204, 255, 0.4);
        }

        .spin-button {
            background: linear-gradient(135deg, #66ccff 0%, #cc99ff 100%);
            color: #0f0f23;
            border: none;
            padding: 16px 50px;
            font-size: 17px;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(102, 204, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .spin-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s;
            z-index: 0;
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(102, 204, 255, 0.6);
        }

        .spin-button:hover:not(:disabled)::before {
            left: 100%;
        }

        .spin-button:active:not(:disabled) {
            transform: translateY(-2px);
        }

        .spin-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result {
            margin-top: 18px;
            min-height: 25px;
            color: #66ccff;
            font-size: 15px;
            opacity: 0.8;
            animation: fadeInOut 1.5s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Prize modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 15, 35, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 9998;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a3e 0%, #16213e 100%);
            border-radius: 25px;
            padding: 40px;
            max-width: 380px;
            width: 90%;
            border: 1px solid rgba(102, 204, 255, 0.2);
            box-shadow: 0 20px 60px rgba(102, 51, 153, 0.5),
                        0 0 40px rgba(102, 204, 255, 0.1);
            animation: modalAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }

        @keyframes modalAppear {
            0% {
                transform: scale(0.8) translateY(20px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-icon {
            font-size: 50px;
            margin-bottom: 15px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .modal-prize {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #66ccff 0%, #cc99ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-message {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .modal-button {
            width: 100%;
            padding: 13px;
            border: none;
            background: linear-gradient(135deg, #66ccff 0%, #cc99ff 100%);
            color: #0f0f23;
            font-weight: 700;
            font-size: 15px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(102, 204, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: 0.5px;
        }

        .modal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 204, 255, 0.5);
        }

        .confetti-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9997;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2.2em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.9em;
                margin-bottom: 16px;
            }

            .top-actions {
                margin-bottom: 20px;
            }

            .login-button {
                padding: 8px 16px;
                font-size: 12px;
            }

            .wheel-container {
                width: 320px;
                height: 320px;
                margin-bottom: 30px;
            }

            .spin-button {
                padding: 14px 40px;
                font-size: 15px;
            }

            .modal {
                padding: 28px 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üé° Lucky Wheel</h1>
    <p class="subtitle">Quay b√°nh xe may m·∫Øn c·ªßa b·∫°n ngay h√¥m nay</p>

    <div class="top-actions">
        <button class="login-button" id="autoLoginBtn">
            üîì T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p tr√™n thi·∫øt b·ªã n√†y
        </button>
    </div>

    <div class="wheel-container">
        <div class="pointer" id="pointer"></div>
        <div class="wheel" id="wheel">
            <svg id="wheelSvg" viewBox="0 0 400 400"></svg>
        </div>
        <div class="center-circle">QUAY</div>
    </div>

    <button class="spin-button" id="spinBtn">QUAY NGAY</button>
    <div class="result" id="status"></div>
</div>

<!-- Prize Result Modal -->
<div class="modal-overlay" id="resultModal">
    <div class="modal">
        <div class="modal-icon" id="modalIcon">üéâ</div>
        <div class="modal-prize" id="modalPrize"></div>
        <div class="modal-message" id="modalMessage"></div>
        <button class="modal-button" onclick="closeModal()">Quay L·∫°i</button>
    </div>
</div>

<div class="confetti-box" id="confettiBox"></div>

<script>
    // prizes s·∫Ω load t·ª´ backend
    let prizes = []; // [{id, name, weight, active}, ...]
    const colors = ["#FF6B6B", "#4ECDC4", "#FFE66D", "#95E1D3", "#F38181", "#AA96DA", "#FCBAD3", "#A8D8EA"];

    const wheel = document.getElementById("wheel");
    const wheelSvg = document.getElementById("wheelSvg");
    const spinBtn = document.getElementById("spinBtn");
    const pointer = document.getElementById("pointer");
    const status = document.getElementById("status");
    const resultModal = document.getElementById("resultModal");
    const modalPrize = document.getElementById("modalPrize");
    const modalMessage = document.getElementById("modalMessage");
    const modalIcon = document.getElementById("modalIcon");
    const confettiBox = document.getElementById("confettiBox");
    const autoLoginBtn = document.getElementById("autoLoginBtn");

    let isSpinning = false;
    let currentRotation = 0;
    let lastPrize = null;

    // th√¥ng tin player
    let playerInfo = null;
    let spinsLeftToday = 0;

    const messages = {
        spinning: ["üåÄ ƒêang quay...", "‚ú® Ch·ªù m·ªôt ch√∫t...", "üéØ Ki·ªÉm tra ph·∫ßn th∆∞·ªüng..."],
        noPrize: ["Ch∆∞a may m·∫Øn l·∫ßn n√†y, th·ª≠ l·∫°i nh√©!", "√îi, h√¥m nay ch∆∞a ph·∫£i ng√†y c·ªßa b·∫°n.", "Kh√¥ng sao, l·∫ßn sau s·∫Ω kh√°c!"],
        normalPrize: ["Ch√∫c m·ª´ng b·∫°n!", "Tuy·ªát v·ªùi!", "Ph·∫ßn th∆∞·ªüng c·ªßa b·∫°n ƒë√¢y!"],
        bigPrize: ["WOW, MAY M·∫ÆN T·ªöI R·ªíI!", "SI√äU MAY M·∫ÆN!", "PH·∫¶N TH∆Ø·ªûNG L·ªöN CH·ªú B·∫†N!"]
    };

    function randomMessage(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    // L·∫•y tr·∫°ng th√°i ng∆∞·ªùi ch∆°i (ƒë√£ login, c√≤n bao nhi√™u l∆∞·ª£t)
    async function fetchPlayerStatus() {
        try {
            const res = await fetch("/api/player/status");
            const data = await res.json();

            if (!data.authenticated) {
                status.textContent = "B·∫•m n√∫t \"T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p tr√™n thi·∫øt b·ªã n√†y\" ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i.";
                spinBtn.disabled = true;
                return;
            }

            playerInfo = data.player;
            spinsLeftToday = data.spins_left_today || 0;

            if (spinsLeftToday <= 0) {
                status.textContent = "H√¥m nay b·∫°n ƒë√£ h·∫øt l∆∞·ª£t quay.";
                spinBtn.disabled = true;
            } else {
                status.textContent = "B·∫°n c√≤n " + spinsLeftToday + " l∆∞·ª£t quay h√¥m nay.";
                spinBtn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            status.textContent = "Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c tr·∫°ng th√°i t√†i kho·∫£n.";
            spinBtn.disabled = true;
        }
    }

    async function fetchPrizes() {
        try {
            const res = await fetch("/api/prizes?active_only=1");
            const data = await res.json();
            prizes = data.prizes || [];
            if (!prizes.length) {
                status.textContent = "Ch∆∞a c√≥ ph·∫ßn th∆∞·ªüng n√†o. H·ªèi admin c·∫•u h√¨nh gi√∫p nh√©.";
                spinBtn.disabled = true;
                return;
            }
            buildWheel();
        } catch (err) {
            console.error(err);
            status.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ph·∫ßn th∆∞·ªüng.";
            spinBtn.disabled = true;
        }
    }

    function buildWheel() {
        wheelSvg.innerHTML = "";
        const size = 400;
        const center = size / 2;
        const radius = size / 2;
        const segmentAngle = (2 * Math.PI) / prizes.length;

        for (let i = 0; i < prizes.length; i++) {
            const startAngle = i * segmentAngle - Math.PI / 2;
            const endAngle = startAngle + segmentAngle;

            const x1 = center + radius * Math.cos(startAngle);
            const y1 = center + radius * Math.sin(startAngle);
            const x2 = center + radius * Math.cos(endAngle);
            const y2 = center + radius * Math.sin(endAngle);

            const largeArcFlag = segmentAngle > Math.PI ? 1 : 0;
            const pathData = [
                `M ${center} ${center}`,
                `L ${x1} ${y1}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                "Z"
            ].join(" ");

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathData);
            path.setAttribute("fill", colors[i % colors.length]);
            path.setAttribute("stroke", "rgba(255, 255, 255, 0.1)");
            path.setAttribute("stroke-width", "3");
            wheelSvg.appendChild(path);

            const textRadius = radius * 0.65;
            const textAngle = startAngle + segmentAngle / 2;
            const tx = center + textRadius * Math.cos(textAngle);
            const ty = center + textRadius * Math.sin(textAngle);

            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", tx);
            text.setAttribute("y", ty);
            text.setAttribute("fill", "#fff");
            text.setAttribute("font-size", "20");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.textContent = prizes[i].name;
            wheelSvg.appendChild(text);
        }
    }

    function createConfetti() {
        const colors = ["#66ccff", "#cc99ff", "#66ff99", "#ffff66", "#ff99cc"];
        for (let i = 0; i < 80; i++) {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = Math.random() * 100 + "%";
            confetti.style.top = "-10px";
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animation = `fall ${2 + Math.random()}s linear forwards`;

            const keyframes = `@keyframes fall {
                to {
                    transform: translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 360}deg);
                    opacity: 0;
                }
            }`;

            if (!document.querySelector("style[data-confetti]")) {
                const style = document.createElement("style");
                style.setAttribute("data-confetti", "true");
                style.textContent = keyframes;
                document.head.appendChild(style);
            }

            confettiBox.appendChild(confetti);
        }

        setTimeout(() => {
            confettiBox.innerHTML = "";
        }, 4000);
    }

    function showModal(prizeName, message) {
        const isBigPrize = prizeName === "1M" || prizeName === "500K";
        modalIcon.textContent = isBigPrize ? "üéÜ" : "üéÅ";
        modalPrize.textContent = prizeName;
        modalMessage.textContent = message;
        resultModal.classList.add("show");

        if (isBigPrize) {
            createConfetti();
        }
    }

    function closeModal() {
        resultModal.classList.remove("show");
    }

    resultModal.addEventListener("click", (e) => {
        if (e.target === resultModal) closeModal();
    });

    function alignWheelToIndex(targetIndex) {
        const segmentAngle = 360 / prizes.length;

        const normCur = ((currentRotation % 360) + 360) % 360;

        const targetAngleFromTop = targetIndex * segmentAngle + segmentAngle / 2;
        let normTarget = (360 - targetAngleFromTop) % 360;

        const extraSpins = 6 + Math.random() * 4;
        const baseRotation = currentRotation + extraSpins * 360;

        const normBase = ((baseRotation % 360) + 360) % 360;
        let delta = normTarget - normBase;
        if (delta < 0) delta += 360;

        const newRotation = baseRotation + delta;

        currentRotation = newRotation;
        wheel.style.transform = `rotate(${newRotation}deg)`;
    }

    async function spinWheel() {
        if (isSpinning || !prizes.length) return;

        if (spinsLeftToday <= 0) {
            status.textContent = "H√¥m nay b·∫°n ƒë√£ h·∫øt l∆∞·ª£t quay.";
            return;
        }

        isSpinning = true;
        spinBtn.disabled = true;
        status.textContent = randomMessage(messages.spinning);

        wheel.classList.add("spinning");

        try {
            const res = await fetch("/api/spin", { method: "POST" });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || "Spin failed");
            }

            lastPrize = data.prize;
            if (typeof data.spins_left_today === "number") {
                spinsLeftToday = data.spins_left_today;
            }

            const idx = prizes.findIndex(p => p.id === lastPrize.id);
            const targetIndex = idx >= 0 ? idx : Math.floor(Math.random() * prizes.length);

            alignWheelToIndex(targetIndex);
        } catch (err) {
            console.error(err);
            isSpinning = false;
            spinBtn.disabled = false;
            wheel.classList.remove("spinning");
            status.textContent = err.message || "C√≥ l·ªói x·∫£y ra, th·ª≠ l·∫°i sau.";
        }
    }

    wheel.addEventListener("transitionend", () => {
        if (!isSpinning) return;

        isSpinning = false;
        wheel.classList.remove("spinning");

        pointer.classList.add("animate");
        setTimeout(() => pointer.classList.remove("animate"), 500);

        let prizeName;
        if (lastPrize && lastPrize.name) {
            prizeName = lastPrize.name;
        } else if (prizes.length) {
            const segmentAngle = 360 / prizes.length;
            let normalizedRotation = ((currentRotation % 360) + 360) % 360;
            let angleFromTop = (-normalizedRotation) % 360;
            if (angleFromTop < 0) angleFromTop += 360;
            let index = Math.floor(angleFromTop / segmentAngle);
            index = (index + prizes.length) % prizes.length;
            prizeName = prizes[index].name;
        } else {
            prizeName = "Kh√¥ng x√°c ƒë·ªãnh";
        }

        let message;
        if (prizeName === "Kh√¥ng C√≥") {
            message = randomMessage(messages.noPrize);
        } else if (prizeName === "1M" || prizeName === "500K") {
            message = randomMessage(messages.bigPrize);
        } else {
            message = randomMessage(messages.normalPrize);
        }

        showModal(prizeName, message);

        if (spinsLeftToday <= 0) {
            status.textContent = "H√¥m nay b·∫°n ƒë√£ h·∫øt l∆∞·ª£t quay.";
            spinBtn.disabled = true;
        } else {
            status.textContent = "B·∫°n c√≤n " + spinsLeftToday + " l∆∞·ª£t quay h√¥m nay.";
            spinBtn.disabled = false;
        }
    });

    spinBtn.addEventListener("click", () => {
        spinWheel();
    });

    document.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !isSpinning) spinWheel();
    });

    // N√∫t t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p ‚Üí g·ªçi /auto-login
    autoLoginBtn.addEventListener("click", () => {
        window.location.href = "/auto-login";
    });

    // Khi load trang: l·∫•y tr·∫°ng th√°i player + danh s√°ch ph·∫ßn th∆∞·ªüng
    (async () => {
        await fetchPlayerStatus();
        await fetchPrizes();
    })();
</script>
</body>
</html>
